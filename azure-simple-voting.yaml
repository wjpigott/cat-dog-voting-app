apiVersion: apps/v1
kind: Deployment
metadata:
  name: azure-simple-voting
  labels:
    app: azure-simple-voting
spec:
  replicas: 1
  selector:
    matchLabels:
      app: azure-simple-voting
  template:
    metadata:
      labels:
        app: azure-simple-voting
    spec:
      containers:
      - name: azure-voting-app
        image: python:3.9-slim
        ports:
        - containerPort: 5000
        command: ["/bin/bash", "-c"]
        args:
          - |
            pip install flask psycopg2-binary requests
            mkdir -p /app
            cd /app
            cat > app.py << 'EOF'
            from flask import Flask, jsonify
            import psycopg2
            import requests
            
            app = Flask(__name__)
            
            def get_azure_votes():
                try:
                    conn = psycopg2.connect(
                        host='postgres-cat-dog-voting.postgres.database.azure.com',
                        port=5432,
                        database='postgres',
                        user='adminuser',
                        password='ComplexPassword123!',
                        sslmode='require'
                    )
                    cursor = conn.cursor()
                    cursor.execute("SELECT option, COUNT(*) FROM vote_option GROUP BY option")
                    rows = cursor.fetchall()
                    votes = {'cat': 0, 'dog': 0}
                    print(f"ðŸ“Š Azure PostgreSQL found {len(rows)} rows:")
                    for option, count in rows:
                        print(f"  Row: option='{option}', count={count}")
                        if option and 'cat' in option.lower():
                            votes['cat'] = count
                        elif option and 'dog' in option.lower():
                            votes['dog'] = count
                    cursor.close()
                    conn.close()
                    print(f"âœ… Final Azure votes: {votes}")
                    return votes
                except Exception as e:
                    print(f"âŒ Azure DB Error: {e}")
                    return {'cat': 0, 'dog': 0}
            
            def get_onprem_votes():
                try:
                    response = requests.get('http://66.242.207.21:31514/api/results', timeout=5)
                    if response.status_code == 200:
                        data = response.json()
                        return data.get('onprem_votes', {'cat': 0, 'dog': 0})
                except:
                    pass
                return {'cat': 0, 'dog': 0}
            
            @app.route('/api/results')
            def api_results():
                azure_votes = get_azure_votes()
                onprem_votes = get_onprem_votes()
                total_cat = azure_votes['cat'] + onprem_votes['cat']
                total_dog = azure_votes['dog'] + onprem_votes['dog']
                return jsonify({
                    'environment': 'azure',
                    'azure_votes': azure_votes,
                    'onprem_votes': onprem_votes,
                    'votes': {'cat': total_cat, 'dog': total_dog},
                    'total_votes': total_cat + total_dog
                })
            
            @app.route('/health')
            def health():
                return jsonify({'status': 'healthy'})
            
            @app.route('/')
            def index():
                return '<h1>Azure Voting App - Simple Test</h1><p><a href="/api/results">API Results</a></p>'
            
            if __name__ == '__main__':
                print("Starting simple Azure voting app...")
                app.run(host='0.0.0.0', port=5000)
            EOF
            python3 app.py

---
apiVersion: v1
kind: Service
metadata:
  name: azure-simple-voting-service
  labels:
    app: azure-simple-voting
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 5000
  selector:
    app: azure-simple-voting