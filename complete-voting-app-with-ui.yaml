apiVersion: apps/v1
kind: Deployment
metadata:
  name: voting-app-azure
spec:
  replicas: 1
  selector:
    matchLabels:
      app: voting-app-azure
  template:
    metadata:
      labels:
        app: voting-app-azure
    spec:
      containers:
      - name: voting-app
        image: python:3.9-slim
        ports:
        - containerPort: 5000
        env:
        - name: DB_HOST
          value: "postgres-service"
        - name: DB_NAME
          value: "voting"
        - name: DB_USER
          value: "postgres"
        - name: DB_PASSWORD
          value: "postgres123"
        - name: AZURE_DB_HOST
          value: "postgres-cat-dog-voting.postgres.database.azure.com"
        - name: AZURE_DB_NAME
          value: "postgres"
        - name: AZURE_DB_USER
          value: "votinguser"
        - name: AZURE_DB_PASSWORD
          value: "SecureVotingPassword123!"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "300m"
        command: ["/bin/sh"]
        args:
          - -c
          - |
            pip install flask psycopg2-binary requests
            cat > /app.py << 'EOF'
            from flask import Flask, render_template, request, jsonify
            import psycopg2
            import os
            import logging
            import requests
            from datetime import datetime

            logging.basicConfig(level=logging.INFO)
            logger = logging.getLogger(__name__)

            app = Flask(__name__)

            def get_azure_db_connection():
                """Get connection to Azure PostgreSQL database"""
                try:
                    conn = psycopg2.connect(
                        host=os.environ['AZURE_DB_HOST'],
                        database=os.environ['AZURE_DB_NAME'],
                        user=os.environ['AZURE_DB_USER'],
                        password=os.environ['AZURE_DB_PASSWORD'],
                        port=5432,
                        sslmode='require'
                    )
                    logger.info("‚úÖ Azure PostgreSQL connection successful!")
                    return conn
                except Exception as e:
                    logger.error(f"‚ùå Azure DB connection error: {e}")
                    return None

            def get_azure_votes_direct():
                """Get Azure votes directly from Azure PostgreSQL database"""
                conn = get_azure_db_connection()
                votes = {'cat': 0, 'dog': 0}

                if conn:
                    try:
                        with conn.cursor() as cursor:
                            cursor.execute("SELECT option, COUNT(*) FROM vote_option GROUP BY option")
                            for vote_type, count in cursor.fetchall():
                                if vote_type and vote_type.lower() in ['cat', 'cats']:
                                    votes['cat'] = count
                                elif vote_type and vote_type.lower() in ['dog', 'dogs']:
                                    votes['dog'] = count
                        conn.close()
                        logger.info(f"‚úÖ Direct Azure DB votes: {votes}")
                    except Exception as e:
                        logger.error(f"‚ùå Azure DB query error: {e}")
                        conn.close()

                return votes

            def get_local_votes():
                """Get local votes from on-premises database"""
                votes = {'cat': 0, 'dog': 0}

                # Try multiple database configurations
                db_configs = [
                    {
                        'host': os.environ.get('DB_HOST', 'postgres-service'),
                        'database': os.environ.get('DB_NAME', 'voting'),
                        'user': os.environ.get('DB_USER', 'postgres'),
                        'password': os.environ.get('DB_PASSWORD', 'postgres123')
                    },
                    {
                        'host': 'postgres-service',
                        'database': 'postgres',
                        'user': 'postgres', 
                        'password': 'postgres123'
                    }
                ]

                for config in db_configs:
                    try:
                        conn = psycopg2.connect(**config)
                        cursor = conn.cursor()
                        
                        query_attempts = [
                            "SELECT vote_choice, COUNT(*) FROM votes GROUP BY vote_choice",
                            "SELECT vote_option, COUNT(*) FROM votes GROUP BY vote_option", 
                            "SELECT option, COUNT(*) FROM votes GROUP BY option"
                        ]
                        
                        for query in query_attempts:
                            try:
                                cursor.execute(query)
                                for vote_type, count in cursor.fetchall():
                                    if vote_type and vote_type.lower() in ['cat', 'cats']:
                                        votes['cat'] = count
                                    elif vote_type and vote_type.lower() in ['dog', 'dogs']:
                                        votes['dog'] = count
                                logger.info(f"‚úÖ Local DB votes: {votes}")
                                conn.close()
                                return votes
                            except Exception:
                                continue
                        conn.close()
                    except Exception:
                        continue

                logger.warning("‚ùå All local database connection attempts failed")
                return votes

            @app.route('/api/results')
            def get_results():
                """API endpoint for getting cross-environment vote results"""
                
                local_votes = get_local_votes()
                azure_votes = get_azure_votes_direct()
                
                total_cat = azure_votes['cat'] + local_votes['cat']
                total_dog = azure_votes['dog'] + local_votes['dog']
                grand_total = total_cat + total_dog
                
                cat_percentage = (total_cat / grand_total * 100) if grand_total > 0 else 0
                dog_percentage = (total_dog / grand_total * 100) if grand_total > 0 else 0

                result = {
                    'environment': 'onprem',
                    'timestamp': datetime.now().isoformat(),
                    'votes': {
                        'cat': {
                            'azure': azure_votes['cat'],
                            'onprem': local_votes['cat'],
                            'total': total_cat,
                            'percentage': round(cat_percentage, 2)
                        },
                        'dog': {
                            'azure': azure_votes['dog'],
                            'onprem': local_votes['dog'], 
                            'total': total_dog,
                            'percentage': round(dog_percentage, 2)
                        }
                    }
                }
                
                logger.info(f"üìä API result: Azure cats={azure_votes['cat']}, dogs={azure_votes['dog']}")
                return jsonify(result)

            @app.route('/vote', methods=['POST'])
            def vote():
                """Handle voting - store in local database"""
                vote_data = request.get_json()
                if not vote_data or 'vote' not in vote_data:
                    return jsonify({'error': 'Invalid vote data'}), 400

                vote_choice = vote_data['vote'].lower()
                if vote_choice not in ['cat', 'dog']:
                    return jsonify({'error': 'Invalid vote choice'}), 400

                # Try to store vote in local database
                db_configs = [
                    {
                        'host': os.environ.get('DB_HOST', 'postgres-service'),
                        'database': os.environ.get('DB_NAME', 'voting'),
                        'user': os.environ.get('DB_USER', 'postgres'),
                        'password': os.environ.get('DB_PASSWORD', 'postgres123')
                    }
                ]

                for config in db_configs:
                    try:
                        conn = psycopg2.connect(**config)
                        cursor = conn.cursor()
                        
                        try:
                            cursor.execute("INSERT INTO votes (vote_choice) VALUES (%s)", (vote_choice,))
                        except:
                            try:
                                cursor.execute("INSERT INTO votes (vote_option) VALUES (%s)", (vote_choice,))
                            except:
                                cursor.execute("INSERT INTO votes (option) VALUES (%s)", (vote_choice,))
                        
                        conn.commit()
                        conn.close()
                        return jsonify({'success': True, 'vote': vote_choice})
                    except Exception as e:
                        logger.error(f"Vote insert error: {e}")
                        continue

                return jsonify({'error': 'Database connection failed'}), 500

            @app.route('/test-azure-db')
            def test_azure_db():
                """Test endpoint for Azure database connection"""
                try:
                    azure_votes = get_azure_votes_direct()
                    return jsonify({
                        'success': True,
                        'azure_votes': azure_votes,
                        'method': 'direct_database_connection'
                    })
                except Exception as e:
                    return jsonify({
                        'success': False,
                        'error': str(e),
                        'method': 'direct_database_connection'
                    })

            @app.route('/debug')
            def debug_connections():
                """Debug endpoint to test all connections"""
                local_votes = get_local_votes()
                azure_votes = get_azure_votes_direct()
                
                return jsonify({
                    'local_votes': local_votes,
                    'azure_direct_votes': azure_votes,
                    'environment_vars': {
                        'DB_HOST': os.environ.get('DB_HOST'),
                        'AZURE_DB_HOST': os.environ.get('AZURE_DB_HOST')
                    }
                })

            @app.route('/health')
            def health():
                return jsonify({
                    'status': 'healthy',
                    'mode': 'complete-voting-app-with-ui',
                    'azure_db_host': os.environ.get('AZURE_DB_HOST')
                })

            @app.route('/')
            def index():
                return '''
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>üåê Cross-Environment Voting App</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0;
                            padding: 0;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            min-height: 100vh;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        
                        .container {
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                            max-width: 900px;
                            width: 90%;
                            text-align: center;
                        }
                        
                        .header {
                            background: linear-gradient(135deg, #667eea, #764ba2);
                            color: white;
                            padding: 30px;
                            border-radius: 15px;
                            margin-bottom: 30px;
                        }
                        
                        .header h1 {
                            margin: 0;
                            font-size: 2.5em;
                            font-weight: bold;
                        }
                        
                        .header h2 {
                            margin: 10px 0 0 0;
                            font-size: 1.3em;
                            opacity: 0.9;
                        }
                        
                        .status {
                            background: linear-gradient(135deg, #56ab2f, #a8e6cf);
                            color: white;
                            padding: 20px;
                            border-radius: 12px;
                            margin: 20px 0;
                            font-weight: bold;
                            font-size: 1.1em;
                        }
                        
                        .voting-section {
                            background: #f8f9fa;
                            padding: 30px;
                            border-radius: 15px;
                            margin: 30px 0;
                        }
                        
                        .voting-section h3 {
                            font-size: 1.8em;
                            margin-bottom: 20px;
                            color: #333;
                        }
                        
                        .vote-buttons {
                            display: flex;
                            gap: 20px;
                            justify-content: center;
                            margin: 20px 0;
                        }
                        
                        .vote-btn {
                            font-size: 28px;
                            padding: 25px 50px;
                            border: none;
                            border-radius: 50px;
                            cursor: pointer;
                            background: linear-gradient(45deg, #667eea, #764ba2);
                            color: white;
                            transition: all 0.3s ease;
                            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
                            font-weight: bold;
                            text-transform: uppercase;
                        }
                        
                        .vote-btn:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 12px 24px rgba(0,0,0,0.3);
                        }
                        
                        .vote-btn:active {
                            transform: translateY(-2px);
                        }
                        
                        .results-section {
                            background: #e9ecef;
                            padding: 30px;
                            border-radius: 15px;
                            margin: 20px 0;
                        }
                        
                        .vote-display {
                            display: flex;
                            gap: 20px;
                            margin: 30px 0;
                        }
                        
                        .vote-card {
                            flex: 1;
                            background: white;
                            padding: 25px;
                            border-radius: 12px;
                            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                        }
                        
                        .vote-card h4 {
                            margin: 0 0 15px 0;
                            font-size: 1.5em;
                        }
                        
                        .vote-count {
                            font-size: 3em;
                            font-weight: bold;
                            margin: 10px 0;
                        }
                        
                        .vote-breakdown {
                            font-size: 0.9em;
                            color: #666;
                            margin: 10px 0;
                        }
                        
                        .percentage {
                            font-size: 1.2em;
                            font-weight: bold;
                            margin: 10px 0;
                        }
                        
                        .controls {
                            margin: 30px 0;
                        }
                        
                        .control-btn {
                            padding: 12px 30px;
                            margin: 8px;
                            border: none;
                            border-radius: 25px;
                            cursor: pointer;
                            background: #28a745;
                            color: white;
                            font-size: 16px;
                            transition: all 0.2s ease;
                        }
                        
                        .control-btn:hover {
                            background: #218838;
                            transform: scale(1.05);
                        }
                        
                        .debug-btn {
                            background: #6c757d;
                        }
                        
                        .debug-btn:hover {
                            background: #5a6268;
                        }
                        
                        .timestamp {
                            font-size: 0.9em;
                            color: #666;
                            margin-top: 20px;
                        }
                        
                        .cat-card {
                            border-left: 5px solid #ffc107;
                            background: linear-gradient(135deg, #fff8dc, #fffbf0);
                        }
                        
                        .dog-card {
                            border-left: 5px solid #17a2b8;
                            background: linear-gradient(135deg, #e3f2fd, #f0f8ff);
                        }
                        
                        .cat-count { color: #ff8f00; }
                        .dog-count { color: #0288d1; }
                        
                        @media (max-width: 768px) {
                            .vote-buttons { flex-direction: column; align-items: center; }
                            .vote-display { flex-direction: column; }
                            .vote-btn { font-size: 24px; padding: 20px 40px; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>üê±üê∂ Cross-Environment Voting App</h1>
                            <h2>üîó Direct Azure Database Access</h2>
                        </div>

                        <div class="status">
                            ‚úÖ Direct Azure PostgreSQL Connection Active<br>
                            üåê Real-time vote synchronization between On-Premises and Azure!
                        </div>

                        <div class="voting-section">
                            <h3>üó≥Ô∏è Cast Your Vote!</h3>
                            <div class="vote-buttons">
                                <button class="vote-btn" onclick="vote('cat')">üê±<br>CATS</button>
                                <button class="vote-btn" onclick="vote('dog')">üê∂<br>DOGS</button>
                            </div>
                        </div>

                        <div class="results-section">
                            <h3>üìä Live Cross-Environment Results</h3>
                            <div id="results">Loading results...</div>
                        </div>

                        <div class="controls">
                            <button class="control-btn" onclick="loadResults()">üîÑ Refresh Results</button>
                            <button class="control-btn debug-btn" onclick="testAzureDb()">üß™ Test Azure DB</button>
                            <button class="control-btn debug-btn" onclick="showDebug()">üîç Debug Info</button>
                        </div>

                        <div id="debug-info" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 10px; margin: 20px 0; text-align: left;">
                            <h4>üîß Debug Information</h4>
                            <div id="debug-content"></div>
                        </div>
                    </div>

                    <script>
                        let debugVisible = false;

                        function vote(animal) {
                            const btn = event.target;
                            btn.style.transform = 'scale(0.95)';
                            
                            fetch('/vote', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({vote: animal})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    showNotification('‚úÖ Vote recorded for ' + animal.toUpperCase() + '!', 'success');
                                    setTimeout(loadResults, 500);
                                } else {
                                    showNotification('‚ùå Error recording vote: ' + (data.error || 'Unknown error'), 'error');
                                }
                                btn.style.transform = '';
                            })
                            .catch(error => {
                                showNotification('‚ùå Network error: ' + error.message, 'error');
                                btn.style.transform = '';
                            });
                        }

                        function testAzureDb() {
                            fetch('/test-azure-db')
                                .then(response => response.json())
                                .then(data => {
                                    const status = data.success ? '‚úÖ' : '‚ùå';
                                    const message = data.success ? 
                                        `Azure DB Connection: ${status} Working! Cats: ${data.azure_votes.cat}, Dogs: ${data.azure_votes.dog}` :
                                        `Azure DB Connection: ${status} Failed - ${data.error}`;
                                    showNotification(message, data.success ? 'success' : 'error');
                                })
                                .catch(error => {
                                    showNotification('‚ùå Test failed: ' + error.message, 'error');
                                });
                        }

                        function showDebug() {
                            debugVisible = !debugVisible;
                            const debugDiv = document.getElementById('debug-info');
                            
                            if (debugVisible) {
                                fetch('/debug')
                                    .then(response => response.json())
                                    .then(data => {
                                        document.getElementById('debug-content').innerHTML = 
                                            '<pre style="background: white; padding: 15px; border-radius: 8px; overflow-x: auto;">' + 
                                            JSON.stringify(data, null, 2) + '</pre>';
                                        debugDiv.style.display = 'block';
                                    });
                            } else {
                                debugDiv.style.display = 'none';
                            }
                        }

                        function loadResults() {
                            fetch('/api/results')
                                .then(response => response.json())
                                .then(data => {
                                    const votes = data.votes;
                                    document.getElementById('results').innerHTML = 
                                        '<div class="vote-display">' +
                                        '<div class="vote-card cat-card">' +
                                        '<h4>üê± CATS</h4>' +
                                        '<div class="vote-count cat-count">' + votes.cat.total + '</div>' +
                                        '<div class="vote-breakdown">Azure: ' + votes.cat.azure + ' | OnPrem: ' + votes.cat.onprem + '</div>' +
                                        '<div class="percentage">' + votes.cat.percentage + '%</div>' +
                                        '</div>' +
                                        '<div class="vote-card dog-card">' +
                                        '<h4>üê∂ DOGS</h4>' +
                                        '<div class="vote-count dog-count">' + votes.dog.total + '</div>' +
                                        '<div class="vote-breakdown">Azure: ' + votes.dog.azure + ' | OnPrem: ' + votes.dog.onprem + '</div>' +
                                        '<div class="percentage">' + votes.dog.percentage + '%</div>' +
                                        '</div>' +
                                        '</div>' +
                                        '<div class="timestamp">üéâ Total Votes: ' + (votes.cat.total + votes.dog.total) + 
                                        ' | Last updated: ' + new Date(data.timestamp).toLocaleString() + '</div>';
                                })
                                .catch(error => {
                                    document.getElementById('results').innerHTML = 
                                        '<p style="color: red;">‚ùå Error loading results: ' + error.message + '</p>';
                                });
                        }

                        function showNotification(message, type) {
                            const notification = document.createElement('div');
                            notification.style.cssText = `
                                position: fixed; top: 20px; right: 20px; z-index: 1000;
                                padding: 15px 25px; border-radius: 8px; color: white;
                                font-weight: bold; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                                background: ${type === 'success' ? '#28a745' : '#dc3545'};
                                animation: slideIn 0.3s ease-out;
                            `;
                            notification.textContent = message;
                            document.body.appendChild(notification);

                            setTimeout(() => {
                                notification.style.animation = 'slideOut 0.3s ease-in';
                                setTimeout(() => notification.remove(), 300);
                            }, 4000);
                        }

                        // Auto-refresh every 15 seconds
                        setInterval(loadResults, 15000);
                        
                        // Load initial results
                        loadResults();
                    </script>

                    <style>
                        @keyframes slideIn {
                            from { transform: translateX(100%); opacity: 0; }
                            to { transform: translateX(0); opacity: 1; }
                        }
                        
                        @keyframes slideOut {
                            from { transform: translateX(0); opacity: 1; }
                            to { transform: translateX(100%); opacity: 0; }
                        }
                    </style>
                </body>
                </html>
                '''

            if __name__ == '__main__':
                logger.info("üéØ Starting COMPLETE on-premises voting app with full UI and Azure database connection...")
                logger.info("üåê Azure DB: postgres-cat-dog-voting.postgres.database.azure.com")
                logger.info("üé® Full voting interface with live Azure data!")
                app.run(host='0.0.0.0', port=5000, debug=False)
            EOF

            python /app.py