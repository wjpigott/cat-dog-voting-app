name: Deploy Azure PostgreSQL Database

# TEMPORARILY DISABLED TO STOP ALL AUTOMATIC RUNS
# Re-enable by uncommenting the 'on' section when needed

# on:
#   workflow_dispatch:
#     inputs:
#       database_name:
#         description: 'PostgreSQL server name'
#         required: false
#         default: 'postgres-cat-dog-voting'

jobs:
  deploy-postgres:
    runs-on: ubuntu-latest
    steps:
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create PostgreSQL Flexible Server
        run: |
          az postgres flexible-server create \
            --resource-group rg-cat-dog-voting-demo \
            --name ${{ github.event.inputs.database_name || 'postgres-cat-dog-voting' }} \
            --location eastus \
            --admin-user votinguser \
            --admin-password "SecureVotingPassword123!" \
            --sku-name Standard_B1ms \
            --tier Burstable \
            --storage-size 32 \
            --version 14 \
            --public-access 0.0.0.0 \
            --yes

      - name: Create Database Schema
        run: |
          SERVER_NAME=${{ github.event.inputs.database_name || 'postgres-cat-dog-voting' }}
          
          # Wait for server to be ready
          sleep 60
          
          # Get server FQDN
          SERVER_FQDN=$(az postgres flexible-server show \
            --resource-group rg-cat-dog-voting-demo \
            --name $SERVER_NAME \
            --query "fullyQualifiedDomainName" \
            --output tsv)
          
          echo "Server FQDN: $SERVER_FQDN"
          
          # Create database and schema using psql
          sudo apt-get update
          sudo apt-get install -y postgresql-client
          
          export PGPASSWORD="SecureVotingPassword123!"
          
          # Create database
          createdb -h $SERVER_FQDN -p 5432 -U votinguser voting_app
          
          # Create schema
          psql -h $SERVER_FQDN -p 5432 -U votinguser -d voting_app -c "
            CREATE TABLE IF NOT EXISTS votes (
                id SERIAL PRIMARY KEY,
                vote_option VARCHAR(10) NOT NULL CHECK (vote_option IN ('cat', 'dog')),
                source VARCHAR(50) NOT NULL,
                timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
            );
            
            CREATE INDEX IF NOT EXISTS idx_votes_option ON votes(vote_option);
            CREATE INDEX IF NOT EXISTS idx_votes_source ON votes(source);
            
            INSERT INTO votes (vote_option, source) VALUES ('cat', 'azure-test');
          "
          
          echo "âœ… PostgreSQL database created successfully!"
          echo "ðŸ”— Connection: $SERVER_FQDN:5432"
          echo "ðŸ“Š Database: voting_app"
          echo "ðŸ‘¤ User: votinguser"