apiVersion: apps/v1
kind: Deployment
metadata:
  name: voting-app-onprem-fixed
  labels:
    app: voting-app-onprem-fixed
spec:
  replicas: 1
  selector:
    matchLabels:
      app: voting-app-onprem-fixed
  template:
    metadata:
      labels:
        app: voting-app-onprem-fixed
    spec:
      containers:
      - name: voting-app
        image: python:3.9-slim
        ports:
        - containerPort: 5000
        env:
        - name: VOTE_SOURCE
          value: "onprem"
        - name: DB_HOST
          value: "postgres-service"
        - name: DB_PORT
          value: "5432"
        - name: DB_NAME
          value: "voting_app"
        - name: DB_USER
          value: "votinguser"
        - name: DB_PASSWORD
          value: "secure_password_123"
        resources:
          requests:
            memory: "128Mi"
            cpu: "100m"
          limits:
            memory: "256Mi"
            cpu: "300m"
        command: ["/bin/bash", "-c"]
        args:
          - |
            echo "üöÄ Installing dependencies..."
            pip install flask psycopg2-binary requests
            
            echo "ÔøΩ Creating app directory..."
            mkdir -p /app
            
            echo "ÔøΩüìù Creating Flask application with DIRECT Azure PostgreSQL connection..."
            cat > /app/app.py << 'PYEOF'
            from flask import Flask, render_template, request, jsonify
            import psycopg2
            import os
            from datetime import datetime

            app = Flask(__name__)

            def get_onprem_db_connection():
                try:
                    return psycopg2.connect(
                        host=os.getenv('DB_HOST', 'postgres-service'),
                        port=int(os.getenv('DB_PORT', '5432')),
                        database=os.getenv('DB_NAME', 'voting_app'),
                        user=os.getenv('DB_USER', 'votinguser'),
                        password=os.getenv('DB_PASSWORD', 'secure_password_123')
                    )
                except Exception as e:
                    print(f"‚ùå OnPrem DB connection error: {e}")
                    return None

            def get_local_votes():
                """Get votes from local on-premises database"""
                conn = get_onprem_db_connection()
                if not conn:
                    return {'cat': 0, 'dog': 0}
                
                try:
                    cursor = conn.cursor()
                    cursor.execute("SELECT vote_choice, COUNT(*) FROM votes GROUP BY vote_choice")
                    results = cursor.fetchall()
                    
                    votes = {'cat': 0, 'dog': 0}
                    for row in results:
                        choice, count = row
                        if choice in votes:
                            votes[choice] = count
                    
                    cursor.close()
                    conn.close()
                    print(f"‚úÖ OnPrem votes: {votes}")
                    return votes
                    
                except Exception as e:
                    print(f"‚ùå Error getting local votes: {e}")
                    return {'cat': 0, 'dog': 0}

            def get_azure_votes():
                """Get votes DIRECTLY from Azure PostgreSQL database"""
                try:
                    print("üîó Connecting to Azure PostgreSQL...")
                    azure_conn = psycopg2.connect(
                        host="postgres-cat-dog-voting.postgres.database.azure.com",
                        database="postgres",
                        user="votinguser",
                        password="SecureVotingPassword123!",
                        port=5432,
                        sslmode='require'
                    )
                    print("‚úÖ Azure PostgreSQL connection successful!")
                    
                    cursor = azure_conn.cursor()
                    cursor.execute("SELECT option, COUNT(*) FROM vote_option GROUP BY option")
                    results = cursor.fetchall()
                    
                    votes = {'cat': 0, 'dog': 0}
                    for row in results:
                        option, count = row
                        print(f"  Azure row: option='{option}', count={count}")
                        if option and option.lower() in ['cat', 'cats']:
                            votes['cat'] = count
                        elif option and option.lower() in ['dog', 'dogs']:
                            votes['dog'] = count
                    
                    cursor.close()
                    azure_conn.close()
                    print(f"‚úÖ Azure votes: {votes}")
                    return votes
                    
                except Exception as e:
                    print(f"‚ùå Error getting Azure votes: {e}")
                    return {'cat': 0, 'dog': 0}

            @app.route('/api/results')
            def api_results():
                """API endpoint for getting cross-environment vote results"""
                
                # Get local on-premises votes
                onprem_votes = get_local_votes()
                
                # Get Azure votes directly from Azure PostgreSQL
                azure_votes = get_azure_votes()
                
                # Calculate totals
                total_cat = azure_votes['cat'] + onprem_votes['cat']
                total_dog = azure_votes['dog'] + onprem_votes['dog']
                
                result = {
                    'environment': 'onprem',
                    'azure_votes': azure_votes,
                    'onprem_votes': onprem_votes,
                    'votes': {'cat': total_cat, 'dog': total_dog},
                    'total_votes': total_cat + total_dog
                }
                
                print(f"üìä API result: {result}")
                return jsonify(result)

            @app.route('/vote', methods=['POST'])
            def vote():
                """Handle voting - store in on-premises database"""
                try:
                    vote_data = request.get_json()
                    if not vote_data or 'vote' not in vote_data:
                        return jsonify({'error': 'Invalid vote data'}), 400

                    vote_choice = vote_data['vote'].lower()
                    if vote_choice not in ['cat', 'dog']:
                        return jsonify({'error': 'Invalid vote choice'}), 400

                    # Store vote in on-premises database
                    conn = get_onprem_db_connection()
                    if conn:
                        cursor = conn.cursor()
                        cursor.execute("INSERT INTO votes (vote_choice, vote_source, timestamp) VALUES (%s, 'onprem', CURRENT_TIMESTAMP)", (vote_choice,))
                        conn.commit()
                        cursor.close()
                        conn.close()
                        print(f"‚úÖ OnPrem vote recorded: {vote_choice}")
                        return jsonify({'success': True, 'vote': vote_choice})
                    else:
                        return jsonify({'error': 'Database connection failed'}), 500
                        
                except Exception as e:
                    print(f"‚ùå Vote error: {e}")
                    return jsonify({'error': str(e)}), 500

            @app.route('/health')
            def health():
                return jsonify({
                    'status': 'healthy', 
                    'environment': 'onprem',
                    'azure_connection': 'direct_postgresql'
                })

            @app.route('/')
            def index():
                return '''
                <!DOCTYPE html>
                <html lang="en">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>üê±üê∂ Cross-Environment Voting - FIXED</title>
                    <style>
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            margin: 0;
                            padding: 40px;
                            min-height: 100vh;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        }
                        .container {
                            background: white;
                            padding: 40px;
                            border-radius: 20px;
                            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
                            max-width: 800px;
                            width: 90%;
                            text-align: center;
                        }
                        .header {
                            background: #28a745;
                            color: white;
                            padding: 25px;
                            border-radius: 15px;
                            margin-bottom: 30px;
                        }
                        .header h1 {
                            margin: 0;
                            font-size: 2.5em;
                        }
                        .header h2 {
                            margin: 10px 0 0 0;
                            font-size: 1.2em;
                            opacity: 0.9;
                        }
                        .vote-section {
                            display: flex;
                            gap: 30px;
                            margin: 30px 0;
                            justify-content: center;
                        }
                        .vote-card {
                            background: #f8f9fa;
                            padding: 30px;
                            border-radius: 15px;
                            flex: 1;
                            border: 3px solid #ddd;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        }
                        .vote-card:hover {
                            transform: translateY(-5px);
                            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
                        }
                        .vote-count {
                            font-size: 3em;
                            font-weight: bold;
                            margin: 15px 0;
                            color: #333;
                        }
                        .results {
                            background: #e9ecef;
                            padding: 25px;
                            border-radius: 12px;
                            margin: 20px 0;
                        }
                        .env-breakdown {
                            display: flex;
                            gap: 20px;
                            margin: 20px 0;
                        }
                        .env-card {
                            background: white;
                            padding: 15px;
                            border-radius: 8px;
                            flex: 1;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        }
                        .azure-card {
                            border-left: 4px solid #0078d4;
                        }
                        .onprem-card {
                            border-left: 4px solid #28a745;
                        }
                        .refresh-btn {
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 12px 25px;
                            border-radius: 25px;
                            cursor: pointer;
                            font-size: 16px;
                            margin: 20px 10px;
                            transition: background 0.3s ease;
                        }
                        .refresh-btn:hover {
                            background: #0056b3;
                        }
                        @media (max-width: 768px) {
                            .vote-section, .env-breakdown {
                                flex-direction: column;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="container">
                        <div class="header">
                            <h1>üê±üê∂ Cross-Environment Voting</h1>
                            <h2>üè† FIXED: Direct Azure PostgreSQL Connection</h2>
                        </div>
                        
                        <div class="vote-section">
                            <div class="vote-card" onclick="vote('cat')">
                                <h3>üê± CATS</h3>
                                <div id="cat-count" class="vote-count">-</div>
                                <p>Click to vote!</p>
                            </div>
                            <div class="vote-card" onclick="vote('dog')">
                                <h3>üê∂ DOGS</h3>
                                <div id="dog-count" class="vote-count">-</div>
                                <p>Click to vote!</p>
                            </div>
                        </div>
                        
                        <div class="results">
                            <h3>üìä Cross-Environment Results</h3>
                            <div class="env-breakdown">
                                <div class="env-card azure-card">
                                    <h4>‚òÅÔ∏è Azure Cloud</h4>
                                    <div id="azure-cats">Cats: -</div>
                                    <div id="azure-dogs">Dogs: -</div>
                                </div>
                                <div class="env-card onprem-card">
                                    <h4>üè† On-Premises</h4>
                                    <div id="onprem-cats">Cats: -</div>
                                    <div id="onprem-dogs">Dogs: -</div>
                                </div>
                            </div>
                            <div id="total-votes"><strong>Total Votes: -</strong></div>
                            <button class="refresh-btn" onclick="loadResults()">üîÑ Refresh Results</button>
                        </div>
                    </div>
                    
                    <script>
                        function vote(animal) {
                            fetch('/vote', {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({vote: animal})
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    alert('‚úÖ Vote recorded for ' + animal.toUpperCase() + '!');
                                    setTimeout(loadResults, 1000);
                                } else {
                                    alert('‚ùå Error: ' + (data.error || 'Unknown error'));
                                }
                            })
                            .catch(error => {
                                alert('‚ùå Network error: ' + error.message);
                            });
                        }
                        
                        function loadResults() {
                            fetch('/api/results')
                                .then(response => response.json())
                                .then(data => {
                                    document.getElementById('cat-count').textContent = data.votes.cat;
                                    document.getElementById('dog-count').textContent = data.votes.dog;
                                    document.getElementById('azure-cats').textContent = 'Cats: ' + data.azure_votes.cat;
                                    document.getElementById('azure-dogs').textContent = 'Dogs: ' + data.azure_votes.dog;
                                    document.getElementById('onprem-cats').textContent = 'Cats: ' + data.onprem_votes.cat;
                                    document.getElementById('onprem-dogs').textContent = 'Dogs: ' + data.onprem_votes.dog;
                                    document.getElementById('total-votes').innerHTML = '<strong>Total Votes: ' + data.total_votes + '</strong>';
                                })
                                .catch(error => {
                                    console.error('Error loading results:', error);
                                });
                        }
                        
                        // Load results on page load and refresh every 15 seconds
                        loadResults();
                        setInterval(loadResults, 15000);
                    </script>
                </body>
                </html>
                '''

            if __name__ == '__main__':
                print("üöÄ Starting FIXED on-premises voting app with DIRECT Azure PostgreSQL connection...")
                print("üîó Azure DB: postgres-cat-dog-voting.postgres.database.azure.com")
                app.run(host='0.0.0.0', port=5000)
            PYEOF

            echo "üóÇÔ∏è Changing to /app directory..."
            cd /app
            echo "üé¨ Starting Flask application..."
            python3 app.py